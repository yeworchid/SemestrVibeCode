# Протокол игры "Бойцы хлопковых плантаций 2"

## Общее описание

Игра использует TCP для связи клиента и сервера. Все сообщения шифруются XOR по статичному ключу.

## Формат сообщения

```
[4 байта: длина] [зашифрованные данные JSON]
```

Данные внутри — JSON с полями:
- `Type` — тип сообщения (число)
- `Payload` — данные сообщения (JSON-объект)

## Типы сообщений

| Код | Название | Направление | Описание |
|-----|----------|-------------|----------|
| 0 | JOIN | клиент → сервер | Подключение к игре |
| 1 | START_GAME | сервер → клиент | Игра началась |
| 2 | ARCHETYPE | клиент → сервер | Выбор архетипа |
| 3 | START_TURN | сервер → клиент | Начало хода |
| 4 | PRODUCTION_RESULT | сервер → клиент | Результат производства |
| 5 | MAKE_SOLDIERS | клиент → сервер | Создать солдат |
| 6 | ATTACK | клиент → сервер | Атаковать игрока |
| 7 | ATTACK_TARGET | сервер → клиент | Результат атаки (атакующему) |
| 8 | ATTACK_RECEIVED | сервер → клиент | Уведомление об атаке (жертве) |
| 9 | BUILD | клиент → сервер | Построить здание |
| 10 | UPGRADE | клиент → сервер | Улучшить здание |
| 11 | END_TURN | клиент → сервер | Завершить ход |
| 12 | TURN_ENDED | сервер → клиент | Ход завершён |
| 13 | STATE | сервер → клиент | Состояние игрока |
| 14 | GAME_END | сервер → клиент | Игра окончена |
| 15 | RESPONSE | сервер → клиент | Ответ на действие |
| 16 | PLAYER_LEFT | сервер → клиент | Игрок отключился |

## Примеры сообщений

### JOIN (подключение)
```json
{
  "Type": 0,
  "Payload": {
    "Nickname": "Игрок1",
    "Email": "player@mail.ru"
  }
}
```

### BUILD (постройка)
```json
{
  "Type": 9,
  "Payload": {
    "PlaceId": 5,
    "Type": 0
  }
}
```
`Type` в Payload — тип здания (0 = Лесозаготовка, 1 = Карьер и т.д.)

### ATTACK (атака)
```json
{
  "Type": 6,
  "Payload": {
    "ToPlayerId": 2,
    "Soldiers": 3
  }
}
```

### STATE (состояние)
```json
{
  "Type": 13,
  "Payload": {
    "Resources": {"Wood": 10, "Stone": 5},
    "Soldiers": 2,
    "Defense": 15,
    "Buildings": [
      {"PlaceId": 0, "Type": 0, "Level": 2}
    ]
  }
}
```

### RESPONSE (ответ)
```json
{
  "Type": 15,
  "Payload": {
    "Success": true,
    "Message": "Построено"
  }
}
```

### PLAYER_LEFT (игрок отключился)
```json
{
  "Type": 16,
  "Payload": {
    "PlayerId": 2,
    "Nickname": "Игрок2",
    "RemainingPlayers": [
      {"Id": 1, "Nickname": "Игрок1", "Email": ""}
    ]
  }
}
```

## Порядок взаимодействия

1. Клиент отправляет `JOIN`
2. Сервер отвечает `RESPONSE` (успех подключения)
3. Когда все игроки подключились — сервер шлёт `START_GAME`
4. Клиенты выбирают архетип (`ARCHETYPE`)
5. Начинается игровой цикл:
   - Сервер шлёт `START_TURN` + `PRODUCTION_RESULT` + `STATE`
   - Игрок делает действия (`BUILD`, `UPGRADE`, `MAKE_SOLDIERS`, `ATTACK`)
   - На каждое действие сервер отвечает `RESPONSE` + `STATE`
   - Игрок завершает ход (`END_TURN`)
   - Сервер шлёт `TURN_ENDED` всем
6. После 15 циклов — `GAME_END`

## Шифрование

XOR с ключом `BHP2_SecretKey_2024!`. Каждый байт сообщения XOR'ится с соответствующим байтом ключа (циклически).
